<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Chamados - SharePoint + MSAL</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="bg-gray-800 p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Sistema de Chamados</h1>
    <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Login Microsoft</button>
  </nav>

  <!-- Ações -->
  <div class="p-4 flex gap-2">
    <button onclick="openModal()" class="bg-green-600 px-4 py-2 rounded-lg">Novo Chamado</button>
    <button onclick="exportExcel()" class="bg-yellow-600 px-4 py-2 rounded-lg">Exportar Excel</button>
    <button onclick="exportPDF()" class="bg-red-600 px-4 py-2 rounded-lg">Exportar PDF</button>
  </div>

  <!-- Lista -->
  <div class="p-4 overflow-x-auto">
    <table class="w-full text-left border border-gray-700">
      <thead class="bg-gray-700">
        <tr>
          <th class="p-2">ID</th>
          <th class="p-2">Título</th>
          <th class="p-2">Descrição</th>
          <th class="p-2">Status</th>
          <th class="p-2">Ações</th>
        </tr>
      </thead>
      <tbody id="ticketsTable"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="ticketModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-96">
      <h2 id="modalTitle" class="text-xl mb-4">Novo Chamado</h2>
      <form id="ticketForm" class="space-y-2">
        <input type="hidden" id="ticketId">
        <input type="text" id="title" placeholder="Título" class="w-full p-2 rounded bg-gray-700">
        <textarea id="description" placeholder="Descrição" class="w-full p-2 rounded bg-gray-700"></textarea>
        <select id="status" class="w-full p-2 rounded bg-gray-700">
          <option value="open">Aberto</option>
          <option value="in_progress">Em andamento</option>
          <option value="resolved">Resolvido</option>
        </select>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeModal()" class="bg-gray-600 px-3 py-1 rounded">Cancelar</button>
          <button type="submit" class="bg-blue-600 px-3 py-1 rounded">Salvar</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* ================================
   CONFIGURAÇÕES
================================ */
const CLIENT_ID   = "SEU_CLIENT_ID";
const TENANT_ID   = "SEU_TENANT_ID";
const SITE_NAME   = "SEU_SITE"; // Ex: SuporteTI
const LIST_NAME   = "Chamados"; // Nome da lista no SharePoint
const SHAREPOINT_URL = `https://${TENANT_ID}.sharepoint.com/sites/${SITE_NAME}`;

emailjs.init("SEU_EMAILJS_USER_ID");

/* ================================
   MSAL AUTH
================================ */
const msalConfig = {
  auth: {
    clientId: CLIENT_ID,
    authority: `https://login.microsoftonline.com/${TENANT_ID}`,
    redirectUri: window.location.origin
  },
  cache: { cacheLocation: "localStorage" }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const loginRequest = { scopes: ["User.Read", "Sites.ReadWrite.All"] };

let accessToken = null;

document.getElementById("loginBtn").onclick = async () => {
  const loginResponse = await msalInstance.loginPopup(loginRequest);
  const tokenResponse = await msalInstance.acquireTokenSilent(loginRequest)
    .catch(() => msalInstance.acquireTokenPopup(loginRequest));
  accessToken = tokenResponse.accessToken;
  alert("Login realizado com sucesso!");
  loadTickets();
};

/* ================================
   SHAREPOINT CRUD
================================ */
async function callSharePoint(endpoint, method = "GET", body = null) {
  if (!accessToken) throw new Error("Não autenticado.");
  const headers = {
    "Authorization": `Bearer ${accessToken}`,
    "Accept": "application/json;odata=verbose",
    "Content-Type": "application/json;odata=verbose"
  };
  const res = await fetch(`${SHAREPOINT_URL}/_api/web/lists/getbytitle('${LIST_NAME}')/${endpoint}`, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined
  });
  return res.json();
}

async function loadTickets() {
  const data = await callSharePoint("items", "GET");
  renderTickets(data.d.results);
}

async function saveTicketToSharePoint(ticket) {
  return await callSharePoint("items", "POST", {
    __metadata: { type: `SP.Data.${LIST_NAME}ListItem` },
    Title: ticket.title,
    Descricao: ticket.description,
    Status: ticket.status
  });
}

async function updateTicketInSharePoint(id, updates) {
  return await callSharePoint(`items(${id})`, "MERGE", {
    __metadata: { type: `SP.Data.${LIST_NAME}ListItem` },
    ...updates
  });
}

/* ================================
   FRONTEND
================================ */
function renderTickets(tickets) {
  const tbody = document.getElementById("ticketsTable");
  tbody.innerHTML = "";
  tickets.forEach(t => {
    const row = `<tr class="border-b border-gray-700">
      <td class="p-2">${t.Id}</td>
      <td class="p-2">${t.Title}</td>
      <td class="p-2">${t.Descricao || ""}</td>
      <td class="p-2">${t.Status}</td>
      <td class="p-2 flex gap-2">
        <button class="bg-yellow-600 px-2 py-1 rounded" onclick="editTicket(${t.Id}, '${t.Title}', '${t.Descricao}', '${t.Status}')">Editar</button>
        <button class="bg-red-600 px-2 py-1 rounded" onclick="closeTicket(${t.Id})">Encerrar</button>
      </td>
    </tr>`;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

/* Modal */
function openModal() { document.getElementById("ticketModal").classList.remove("hidden"); }
function closeModal() { document.getElementById("ticketModal").classList.add("hidden"); }

function editTicket(id, title, desc, status) {
  document.getElementById("ticketId").value = id;
  document.getElementById("title").value = title;
  document.getElementById("description").value = desc;
  document.getElementById("status").value = status;
  document.getElementById("modalTitle").textContent = "Editar Chamado";
  openModal();
}

/* Salvar Chamado */
document.getElementById("ticketForm").onsubmit = async (e) => {
  e.preventDefault();
  const id = document.getElementById("ticketId").value;
  const ticket = {
    title: document.getElementById("title").value,
    description: document.getElementById("description").value,
    status: document.getElementById("status").value
  };
  if (id) {
    await updateTicketInSharePoint(id, ticket);
    sendEmail("Chamado atualizado", ticket.title, ticket.description, ticket.status);
  } else {
    await saveTicketToSharePoint(ticket);
    sendEmail("Novo chamado aberto", ticket.title, ticket.description, ticket.status);
  }
  closeModal();
  loadTickets();
};

/* Encerrar Chamado */
async function closeTicket(id) {
  await updateTicketInSharePoint(id, { Status: "resolved" });
  sendEmail("Chamado encerrado", `Chamado ID ${id}`, "Encerrado", "resolved");
  loadTickets();
}

/* ================================
   EMAILJS
================================ */
function sendEmail(subject, title, description, status) {
  emailjs.send("SEU_SERVICE_ID", "SEU_TEMPLATE_ID", {
    subject, title, description, status
  }).then(() => console.log("E-mail enviado!"));
}

/* ================================
   EXPORTAÇÃO
================================ */
function exportExcel() {
  const table = document.getElementById("ticketsTable");
  const wb = XLSX.utils.table_to_book(table, { sheet: "Chamados" });
  XLSX.writeFile(wb, "chamados.xlsx");
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Relatório de Chamados", 10, 10);
  doc.autoTable({ html: "#ticketsTable" });
  doc.save("chamados.pdf");
}
</script>
</body>
</html>
