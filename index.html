/* =========================
    Persistence keys & defaults
    ========================= */
const STORAGE_KEY = "tickets_v1";
const CFG_KEY = "tickets_cfg_v1";

function loadTickets() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
function saveTickets(t) { localStorage.setItem(STORAGE_KEY, JSON.stringify(t)); }
function loadCfg() { return JSON.parse(localStorage.getItem(CFG_KEY) || "{}"); }
function saveCfg(c) { localStorage.setItem(CFG_KEY, JSON.stringify(c)); }

let tickets = loadTickets();
let cfg = Object.assign({
  serviceId: "",
  templateId: "",
  publicKey: "",
  internals: "",
  subjectOpen: "Novo Chamado Aberto",
  subjectClose: "Chamado Encerrado",
  technicians: "João Silva, Maria Oliveira, Carlos Souza"
}, loadCfg());
let editingTicketId = null;
let prevStats = { total: -1, open: -1, inProgress: -1, resolved: -1 };
/* DOM refs */
const tabs = { tickets: document.getElementById("tabTickets"), config: document.getElementById("tabConfig") };
const btnTabTickets = document.getElementById("tabTicketsBtn");
const btnTabConfig = document.getElementById("tabConfigBtn");
const ticketsList = document.getElementById("ticketsList");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const priorityFilter = document.getElementById("priorityFilter");

const statTotal = document.getElementById("statTotal");
const statOpen = document.getElementById("statOpen");
const statInProgress = document.getElementById("statInProgress");
const statResolved = document.getElementById("statResolved");
const cardTotal = document.getElementById("cardTotal");
const cardOpen = document.getElementById("cardOpen");
const cardInProgress = document.getElementById("cardInProgress");
const cardResolved = document.getElementById("cardResolved");

const openTicketModalBtn = document.getElementById("openTicketModal");
const ticketModal = document.getElementById("ticketModal");
const closeTicketModal = document.getElementById("closeTicketModal");
const ticketForm = document.getElementById("ticketForm");
const modalTitle = document.getElementById("modalTitle");
const saveTicketBtn = document.getElementById("saveTicketBtn");
const cancelTicketBtn = document.getElementById("cancelTicketBtn");

const cfgServiceId = document.getElementById("cfgServiceId");
const cfgTemplateId = document.getElementById("cfgTemplateId");
const cfgPublicKey = document.getElementById("cfgPublicKey");
const cfgInternals = document.getElementById("cfgInternals");
const cfgSubjectOpen = document.getElementById("cfgSubjectOpen");
const cfgSubjectClose = document.getElementById("cfgSubjectClose");
const cfgTechnicians = document.getElementById("cfgTechnicians");
const saveConfigBtn = document.getElementById("saveConfigBtn");
const resetConfigBtn = document.getElementById("resetConfigBtn");
const configMsg = document.getElementById("configMsg");
const saveTechBtn = document.getElementById("saveTechBtn");
const techMsg = document.getElementById("techMsg");

const exportMenu = document.getElementById("exportMenu");
const generateReportBtn = document.getElementById("generateReportBtn");
const exportExcelBtn = document.getElementById("exportExcel");
const exportPDFBtn = document.getElementById("exportPDF");
const exportCSVBtn = document.getElementById("exportCSV");

/* =========================
    Email helpers (EmailJS)
    ========================= */
function ensureEmailInit() {
  if (cfg.publicKey) {
    try { emailjs.init(cfg.publicKey); } catch(e){ /* ignore */ }
  }
}

function sendEmailRaw({ to, subject, body }) {
  if (!cfg.serviceId || !cfg.templateId || !cfg.publicKey) {
    console.warn("E-mail não enviado: dados EmailJS não configurados.");
    return Promise.resolve("not-configured");
  }
  ensureEmailInit();

  // EmailJS templates usually accept named variables. We pass common ones.
  const templateParams = {
    to_email: to,
    subject: subject,
    message: body,
    // additional helpers if needed:
    site: window.location.origin
  };
  // emailjs.send returns a promise
  return emailjs.send(cfg.serviceId, cfg.templateId, templateParams);
}

function notifyInternals(subject, body) {
  if (!cfg.internals) return Promise.resolve("no-internals");
  const list = cfg.internals.split(",").map(s => s.trim()).filter(Boolean);
  // send to each internal separately (best-effort)
  const promises = list.map(to => sendEmailRaw({ to, subject, body }).catch(e => e));
  return Promise.allSettled(promises);
}

function notifyClient(clientEmail, subject, body) {
  if (!clientEmail) return Promise.resolve("no-client");
  return sendEmailRaw({ to: clientEmail, subject, body }).catch(e => e);
}

/* =========================
    Tab navigation
    ========================= */
function showTab(name) {
  if (name === "tickets") { tabs.tickets.classList.remove("hidden"); tabs.config.classList.add("hidden"); }
  else { tabs.tickets.classList.add("hidden"); tabs.config.classList.remove("hidden"); }
}
btnTabTickets.addEventListener("click", () => showTab("tickets"));
btnTabConfig.addEventListener("click", () => showTab("config"));
/* =========================
    Config UI
    ========================= */
function loadCfgToUI() {
  cfgServiceId.value = cfg.serviceId || "";
  cfgTemplateId.value = cfg.templateId || "";
  cfgPublicKey.value = cfg.publicKey || "";
  cfgInternals.value = cfg.internals || "";
  cfgSubjectOpen.value = cfg.subjectOpen || "";
  cfgSubjectClose.value = cfg.subjectClose || "";
  cfgTechnicians.value = cfg.technicians || "";
}
loadCfgToUI();
saveConfigBtn.addEventListener("click", () => {
  cfg.serviceId = cfgServiceId.value.trim();
  cfg.templateId = cfgTemplateId.value.trim();
  cfg.publicKey = cfgPublicKey.value.trim();
  cfg.internals = cfgInternals.value.trim();
  cfg.subjectOpen = cfgSubjectOpen.value.trim() || cfg.subjectOpen;
  cfg.subjectClose = cfgSubjectClose.value.trim() || cfg.subjectClose;
  cfg.technicians = cfgTechnicians.value.trim();
  saveCfg(cfg);
  configMsg.classList.remove("hidden");
  setTimeout(()=>configMsg.classList.add("hidden"), 2200);
  populateTechniciansSelect();
  ensureEmailInit();
});
resetConfigBtn.addEventListener("click", () => {
  cfg = {
    serviceId: "",
    templateId: "",
    publicKey: "",
    internals: "",
    subjectOpen: "Novo Chamado Aberto",
    subjectClose: "Chamado Encerrado",
    technicians: "João Silva, Maria Oliveira, Carlos Souza"
  };
  saveCfg(cfg);
  loadCfgToUI();
  populateTechniciansSelect();
  configMsg.classList.remove("hidden");
  setTimeout(()=>configMsg.classList.add("hidden"), 2200);
});
saveTechBtn.addEventListener("click", () => {
  cfg.technicians = cfgTechnicians.value.trim();
  saveCfg(cfg);
  techMsg.classList.remove("hidden");
  setTimeout(()=>techMsg.classList.add("hidden"), 2000);
  populateTechniciansSelect();
});
/* =========================
    Technicians select
    ========================= */
function getTechnicians() {
  const raw = cfg.technicians || "";
  return raw.split(",").map(s => s.trim()).filter(Boolean);
}
function populateTechniciansSelect() {
  const sel = document.getElementById("technician");
  sel.innerHTML = "<option value=''>Selecione</option>";
  getTechnicians().forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
}
populateTechniciansSelect();

/* =========================
    Stats utils
    ========================= */
function animateCard(card) {
  card.classList.remove("highlight");
  void card.offsetWidth;
  card.classList.add("highlight");
}
function updateStats() {
  const total = tickets.length;
  const open = tickets.filter(t => t.status === "open").length;
  const inProgress = tickets.filter(t => t.status === "in-progress").length;
  const resolved = tickets.filter(t => t.status === "resolved").length;
  if (total !== prevStats.total) animateCard(cardTotal);
  if (open !== prevStats.open) animateCard(cardOpen);
  if (inProgress !== prevStats.inProgress) animateCard(cardInProgress);
  if (resolved !== prevStats.resolved) animateCard(cardResolved);
  statTotal.textContent = total;
  statOpen.textContent = open;
  statInProgress.textContent = inProgress;
  statResolved.textContent = resolved;

  prevStats = { total, open, inProgress, resolved };
}

/* =========================
    Render tickets list
    ========================= */
function escapeHtml(str) {
  if (!str) return "";
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'", "&#39;");
}

function getFilteredTickets() {
  const searchTerm = (searchInput.value || "").toLowerCase();
  const statusTerm = statusFilter.value;
  const priorityTerm = priorityFilter.value;

  return tickets.filter(ticket => {
    const matchSearch =
      ticket.subject.toLowerCase().includes(searchTerm) ||
      ticket.clientName.toLowerCase().includes(searchTerm) ||
      (ticket.clientEmail || "").toLowerCase().includes(searchTerm) ||
      (ticket.technician || "").toLowerCase().includes(searchTerm) ||
      (ticket.description || "").toLowerCase().includes(searchTerm);
    const matchStatus = statusTerm ? ticket.status === statusTerm : true;
    const matchPriority = priorityTerm ? ticket.priority === priorityTerm : true;
    return matchSearch && matchStatus && matchPriority;
  });
}

function displayTickets() {
  const filtered = getFilteredTickets();
  ticketsList.innerHTML = "";

  if (!filtered.length) {
    ticketsList.innerHTML = `<tr><td colspan="8" class="px-4 py-6 text-center text-gray-500">Nenhum chamado encontrado.</td></tr>`;
    updateStats();
    return;
  }

  filtered.forEach(ticket => {
    const tr = document.createElement("tr");
    tr.className = ticket.priority ? `priority-${ticket.priority}` : "";
    tr.innerHTML = `
      <td class="px-4 py-3">${ticket.id}</td>
      <td class="px-4 py-3 font-medium">${escapeHtml(ticket.subject)}</td>
      <td class="px-4 py-3">${escapeHtml(ticket.clientName)}<div class="text-xs text-gray-400">${escapeHtml(ticket.clientEmail)}</div></td>
      <td class="px-4 py-3">${escapeHtml(ticket.technician)}</td>
      <td class="px-4 py-3 capitalize">${ticket.priority}</td>
      <td class="px-4 py-3 capitalize">${ticket.status.replace("-", " ")}</td>
      <td class="px-4 py-3">${ticket.date}</td>
      <td class="px-4 py-3 space-x-1">
        ${ticket.status !== "resolved" ? `<button class="closeBtn bg-green-600 text-white px-2 py-1 rounded text-xs"><i class="fas fa-check mr-1"></i>Encerrar</button>` : ""}
        <button class="viewBtn bg-blue-500 text-white px-2 py-1 rounded text-xs"><i class="fas fa-eye mr-1"></i>Ver</button>
        ${ticket.status !== "resolved" ? `<button class="editBtn bg-yellow-500 text-white px-2 py-1 rounded text-xs"><i class="fas fa-pen mr-1"></i>Editar</button>` : ""}
      </td>
    `;
    if (ticket.status !== "resolved") {
      tr.querySelector(".closeBtn").addEventListener("click", async () => {
        ticket.status = "resolved";
        saveTickets(tickets);
        // notify internals and client (best-effort)
        notifyInternals(cfg.subjectClose, `Chamado ID ${ticket.id} encerrado.\nAssunto: ${ticket.subject}`).catch(()=>{});
        notifyClient(ticket.clientEmail, cfg.subjectClose, `Olá ${ticket.clientName},\n\nSeu chamado (ID ${ticket.id}) foi encerrado.\nAssunto: ${ticket.subject}\n\nObrigado.`).catch(()=>{});
        displayTickets();
        alert(`Chamado ID ${ticket.id} encerrado.`);
      });
    }

    tr.querySelector(".viewBtn").addEventListener("click", () => {
      openModalForTicket(ticket, { viewOnly: true });
    });
    if (tr.querySelector(".editBtn")) {
      tr.querySelector(".editBtn").addEventListener("click", () => {
        editingTicketId = ticket.id;
        openModalForTicket(ticket, { viewOnly: false });
      });
    }

    ticketsList.appendChild(tr);
  });

  updateStats();
}

/* =========================
    Modal handling: create/edit/view
    ========================= */
function openModalForTicket(ticket = null, { viewOnly = false } = {}) {
  const subjectEl = document.getElementById("subject");
  const priorityEl = document.getElementById("priority");
  const technicianEl = document.getElementById("technician");
  const statusEl = document.getElementById("status");
  const clientNameEl = document.getElementById("clientName");
  const clientEmailEl = document.getElementById("clientEmail");
  const descriptionEl = document.getElementById("description");

  if (ticket) {
    modalTitle.textContent = viewOnly ? `Visualizar Chamado #${ticket.id}` : `Editar Chamado #${ticket.id}`;
    subjectEl.value = ticket.subject;
    priorityEl.value = ticket.priority;
    technicianEl.value = ticket.technician;
    statusEl.value = ticket.status;
    clientNameEl.value = ticket.clientName;
    clientEmailEl.value = ticket.clientEmail;
    descriptionEl.value = ticket.description;
  } else {
    modalTitle.textContent = "Abrir Chamado";
    subjectEl.value = "";
    priorityEl.value = "";
    technicianEl.value = "";
    statusEl.value = "open";
    clientNameEl.value = "";
    clientEmailEl.value = "";
    descriptionEl.value = "";
  }

  if (viewOnly) {
    Array.from(ticketForm.elements).forEach(el => el.disabled = true);
    saveTicketBtn.classList.add("hidden");
  } else {
    Array.from(ticketForm.elements).forEach(el => el.disabled = false);
    saveTicketBtn.classList.remove("hidden");
  }

  ticketModal.classList.remove("hidden");
}

openTicketModalBtn.addEventListener("click", () => { editingTicketId = null; openModalForTicket(null, { viewOnly:false }); populateTechniciansSelect(); });
closeTicketModal.addEventListener("click", () => ticketModal.classList.add("hidden"));
cancelTicketBtn.addEventListener("click", () => ticketModal.classList.add("hidden"));

/* =========================
    submit (create / edit)
    ========================= */
ticketForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const subject = document.getElementById("subject").value.trim();
  const priority = document.getElementById("priority").value;
  const technician = document.getElementById("technician").value;
  const status = document.getElementById("status").value;
  const clientName = document.getElementById("clientName").value.trim();
  const clientEmail = document.getElementById("clientEmail").value.trim();
  const description = document.getElementById("description").value.trim();

  if (!subject || !clientName || !clientEmail) {
    alert("Preencha Assunto, Nome e E-mail do cliente.");
    return;
  }

  if (editingTicketId) {
    // edição
    const t = tickets.find(x => x.id === editingTicketId);
    if (!t) { alert("Chamado não encontrado."); ticketModal.classList.add("hidden"); return; }

    t.subject = subject;
    t.priority = priority;
    t.technician = technician;
    t.status = status;
    t.clientName = clientName;
    t.clientEmail = clientEmail;
    t.description = description;
    saveTickets(tickets);
    // notificar internals
    notifyInternals(`Chamado Editado - ID ${t.id}`, `O chamado ID ${t.id} foi editado.\nAssunto: ${t.subject}\nCliente: ${t.clientName}\nPrioridade: ${t.priority}`)
      .then(()=>{})
      .catch(()=>{});
    alert("Chamado atualizado.");
  } else {
    // criação
    const newId = tickets.length ? Math.max(...tickets.map(x => x.id)) + 1 : 1;
    const newTicket = {
      id: newId,
      subject,
      priority,
      technician,
      status,
      clientName,
      clientEmail,
      description,
      date: new Date().toLocaleDateString()
    };
    tickets.push(newTicket);
    saveTickets(tickets);

    // notificar internals + confirmar para cliente (ambos best-effort)
    notifyInternals(cfg.subjectOpen || "Novo Chamado Aberto", `Novo chamado ID ${newTicket.id}\nAssunto: ${newTicket.subject}\nCliente: ${newTicket.clientName}\nPrioridade: ${newTicket.priority}`).catch(()=>{});
    notifyClient(newTicket.clientEmail, cfg.subjectOpen || "Seu chamado foi recebido", `Olá ${newTicket.clientName},\n\nRecebemos seu chamado (ID ${newTicket.id}).\nAssunto: ${newTicket.subject}\nTécnico: ${newTicket.technician}\n\nResponderemos em breve.`).catch(()=>{});
    alert("Chamado criado com sucesso.");
  }

  ticketModal.classList.add("hidden");
  editingTicketId = null;
  displayTickets();
});
/* =========================
    Filters & search
    ========================= */
searchInput.addEventListener("input", displayTickets);
statusFilter.addEventListener("change", displayTickets);
priorityFilter.addEventListener("change", displayTickets);
/* =========================
    Generate report (exports)
    ========================= */
generateReportBtn.addEventListener("click", (e) => {
  exportMenu.classList.toggle("hidden");
});
// click outside to close export menu
document.addEventListener("click", (ev) => {
  if (!generateReportBtn.contains(ev.target) && !exportMenu.contains(ev.target)) {
    exportMenu.classList.add("hidden");
  }
});
function getVisibleRowsForExport() {
  // Return array of objects with the table columns
  const filtered = getFilteredTickets();
  return filtered.map(t => ({
    ID: t.id,
    Assunto: t.subject,
    Cliente: `${t.clientName} (${t.clientEmail || ""})`,
    Tecnico: t.technician || "",
    Prioridade: t.priority,
    Status: t.status.replace("-", " "),
    Data: t.date
  }));
}

function timestampFileName(ext) {
  const now = new Date();
  const pad = n => String(n).padStart(2, "0");
  const date = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  const time = `${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
  return `relatorio_chamados_${date}_${time}.${ext}`;
}

exportExcelBtn.addEventListener("click", () => {
  const rows = getVisibleRowsForExport();
  if (!rows.length) { alert("Nenhum chamado encontrado para exportar."); return; }

  // Convert to worksheet
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Chamados");
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], { type: "application/octet-stream" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = timestampFileName("xlsx");
  a.click();
  URL.revokeObjectURL(url);
  exportMenu.classList.add("hidden");
});
exportCSVBtn.addEventListener("click", () => {
  const rows = getVisibleRowsForExport();
  if (!rows.length) { alert("Nenhum chamado encontrado para exportar."); return; }
  const header = Object.keys(rows[0]).join(",") + "\n";
  const lines = rows.map(r => Object.values(r).map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const csv = header + lines;
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = timestampFileName("csv");
  a.click();
  URL.revokeObjectURL(url);
  exportMenu.classList.add("hidden");
});

exportPDFBtn.addEventListener("click", () => {
  const rows = getVisibleRowsForExport();
  if (!rows.length) { alert("Nenhum chamado encontrado para exportar."); return; }

  // Build columns and data for autoTable
  const columns = Object.keys(rows[0]);
  const data = rows.map(r => columns.map(c => String(r[c])));
  // Using jspdf from UMD (window.jspdf)
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape', 'pt', 'a4');
  doc.setFontSize(14);
  doc.text("Relatório de Chamados", 40, 40);
  doc.setFontSize(10);
  doc.text(`Gerado em: ${new Date().toLocaleString()}`, 40, 58);
  doc.autoTable({
    head: [columns],
    body: data,
    startY: 80,
    styles: { fontSize: 9, cellPadding: 4 },
    headStyles: { fillColor: [33, 150, 243] }
  });
  doc.save(timestampFileName("pdf"));
  exportMenu.classList.add("hidden");
});

/* =========================
    Bootstrap: display, load cfg into UI
    ========================= */
function init() {
  loadCfgToUI();
  populateTechniciansSelect();
  displayTickets();
  updateStats();
  ensureEmailInit();
}
init();
