<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Chamados</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 6px; }
    @keyframes blinkHighlight { 0% { background-color: #fce7f3; } 50% { background-color: #f9a8d4; } 100% { background-color: #fce7f3; } }
    .blink { animation: blinkHighlight 1s ease-in-out 3; }
    .highlight { background-color: #dcfce7 !important; transition: background-color 1s ease; }
    .priority-low td { background-color: #ecfdf5; }
    .priority-medium td { background-color: #fef9c3; }
    .priority-high td { background-color: #fee2e2; }
    .priority-critical td { background-color: #fce7f3; font-weight: 600; color:#7c1d6f; }
    #exportMenu { min-width: 160px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="min-h-screen">
    <header class="bg-orange-600 text-white shadow">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold">Sistema de Chamados</h1>
          <p class="text-orange-100 text-sm">Flask + SQLite</p>
        </div>
      </div>
    </header>

    <main class="container mx-auto px-4 py-6">
      <!-- Formulário -->
      <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="text-lg font-semibold mb-3">Abrir Novo Chamado</h2>
        <form id="ticketForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <input id="subject" type="text" placeholder="Assunto" class="border rounded px-3 py-2" required />
          <input id="client" type="text" placeholder="Nome do cliente" class="border rounded px-3 py-2" required />
          <input id="clientEmail" type="email" placeholder="E-mail do cliente (opcional)" class="border rounded px-3 py-2" />
          <input id="tech" type="text" placeholder="Técnico responsável" class="border rounded px-3 py-2" required />
          <select id="priority" class="border rounded px-3 py-2" required>
            <option value="">Selecione prioridade</option>
            <option value="low">Baixa</option>
            <option value="medium">Média</option>
            <option value="high">Alta</option>
            <option value="critical">Crítica</option>
          </select>
          <textarea id="description" placeholder="Descrição do problema" class="border rounded px-3 py-2 md:col-span-2" rows="3" required></textarea>

          <div class="md:col-span-2 flex gap-2 justify-end">
            <button type="submit" class="bg-orange-600 text-white px-4 py-2 rounded">Abrir Chamado</button>
            <button type="button" id="refreshBtn" class="bg-gray-200 px-4 py-2 rounded">Atualizar</button>
          </div>
        </form>
      </div>

      <!-- Ações / filtros -->
      <div class="bg-white p-4 rounded shadow mb-4 flex flex-wrap gap-3 items-center">
        <div class="flex gap-2 items-center">
          <input id="searchInput" type="search" placeholder="Buscar assunto, cliente, técnico..." class="border rounded px-3 py-2" />
        </div>
        <div class="flex gap-2 items-center ml-auto">
          <button id="generateReportBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Exportar</button>
          <div id="exportMenu" class="hidden absolute bg-white border rounded shadow p-2">
            <button id="exportExcel" class="block w-full text-left px-2 py-1">Exportar Excel</button>
            <button id="exportPDF" class="block w-full text-left px-2 py-1">Exportar PDF</button>
          </div>
        </div>
      </div>

      <!-- Tabela -->
      <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assunto</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente / Email</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Técnico</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prioridade</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
            </tr>
          </thead>
          <tbody id="ticketsList" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Modal: details -->
  <div id="detailsModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white w-11/12 md:w-1/2 rounded p-5 shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Detalhes do Chamado</h3>
        <button id="closeDetailsBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>
      <div id="detailsBody" class="space-y-2 text-gray-800"></div>
      <div class="mt-4 text-right">
        <button id="openEditFromDetails" class="bg-yellow-500 text-white px-3 py-2 rounded mr-2">Editar</button>
        <button id="closeFromDetails" class="bg-green-600 text-white px-3 py-2 rounded">Encerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: edit -->
  <div id="editModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white w-11/12 md:w-1/2 rounded p-5 shadow-lg">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Editar Chamado</h3>
        <button id="closeEditBtn" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>
      <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input id="editSubject" class="border p-2 rounded" required />
        <input id="editClient" class="border p-2 rounded" required />
        <input id="editClientEmail" class="border p-2 rounded" />
        <input id="editTech" class="border p-2 rounded" required />
        <select id="editPriority" class="border p-2 rounded">
          <option value="low">Baixa</option>
          <option value="medium">Média</option>
          <option value="high">Alta</option>
          <option value="critical">Crítica</option>
        </select>
        <select id="editStatus" class="border p-2 rounded">
          <option value="open">Aberto</option>
          <option value="in-progress">Em andamento</option>
          <option value="resolved">Resolvido</option>
        </select>
        <textarea id="editDescription" class="border p-2 rounded md:col-span-2" rows="4"></textarea>
        <div class="md:col-span-2 text-right">
          <button type="button" id="saveEditBtn" class="bg-orange-600 text-white px-3 py-2 rounded">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: close confirmation -->
  <div id="closeModalConfirm" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white w-96 rounded p-6 shadow-lg">
      <h3 class="text-lg font-semibold mb-3">Encerrar Chamado</h3>
      <p id="closeConfirmText"></p>
      <div class="mt-4 text-right">
        <button id="cancelCloseConfirm" class="px-3 py-2 rounded bg-gray-200 mr-2">Cancelar</button>
        <button id="confirmCloseBtn" class="px-3 py-2 rounded bg-green-600 text-white">Encerrar</button>
      </div>
    </div>
  </div>

<script>
(async function(){
  /* Helper to call API */
  async function api(path, opts = {}) {
    const res = await fetch(path, opts);
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`${res.status} ${txt}`);
    }
    return res.json();
  }

  // DOM refs
  const ticketForm = document.getElementById("ticketForm");
  const ticketsList = document.getElementById("ticketsList");
  const searchInput = document.getElementById("searchInput");
  const refreshBtn = document.getElementById("refreshBtn");
  const exportMenu = document.getElementById("exportMenu");
  const generateBtn = document.getElementById("generateReportBtn");
  const exportExcelBtn = document.getElementById("exportExcel");
  const exportPDFBtn = document.getElementById("exportPDF");

  let tickets = [];
  let currentDetailsId = null;
  let currentEditId = null;
  let closeCandidateId = null;

  // Fetch and render
  async function loadTickets(){
    tickets = await api("/api/tickets");
    renderTickets();
  }

  function escapeHtml(s){ if(!s) return ""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  function renderTickets(){
    const q = (searchInput.value||"").toLowerCase();
    ticketsList.innerHTML = "";
    tickets.forEach(t => {
      if (q) {
        const hay = (t.subject + " " + t.client + " " + (t.client_email||"") + " " + t.tech + " " + (t.description||"")).toLowerCase();
        if (!hay.includes(q)) return;
      }
      const tr = document.createElement("tr");
      tr.className = `priority-${t.priority}`;
      tr.innerHTML = `
        <td class="px-4 py-3">${t.id}</td>
        <td class="px-4 py-3 font-medium">${escapeHtml(t.subject)}</td>
        <td class="px-4 py-3">${escapeHtml(t.client)}<div class="text-xs text-gray-400">${escapeHtml(t.client_email||"")}</div></td>
        <td class="px-4 py-3">${escapeHtml(t.tech)}</td>
        <td class="px-4 py-3 capitalize">${escapeHtml(t.priority)}</td>
        <td class="px-4 py-3 capitalize">${escapeHtml(t.status)}</td>
        <td class="px-4 py-3">${escapeHtml(t.date)}</td>
        <td class="px-4 py-3 space-x-2">
          <button data-id="${t.id}" class="viewBtn text-blue-600 hover:underline">Detalhes</button>
          ${t.status !== "resolved" ? `<button data-id="${t.id}" class="closeBtn text-green-600 hover:underline">Encerrar</button>` : "✅ Encerrado"}
        </td>
      `;
      ticketsList.appendChild(tr);

      if (t.priority === "critical" && t.status !== "resolved") tr.classList.add("blink");
    });

    // wire buttons
    document.querySelectorAll(".viewBtn").forEach(b => b.addEventListener("click", e => {
      const id = Number(e.currentTarget.dataset.id); openDetails(id);
    }));
    document.querySelectorAll(".closeBtn").forEach(b => b.addEventListener("click", e => {
      const id = Number(e.currentTarget.dataset.id); openCloseConfirm(id);
    }));
  }

  // create ticket
  ticketForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      subject: document.getElementById("subject").value,
      description: document.getElementById("description").value,
      client: document.getElementById("client").value,
      client_email: document.getElementById("clientEmail").value,
      tech: document.getElementById("tech").value,
      priority: document.getElementById("priority").value
    };
    try {
      await api("/api/tickets", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
      ticketForm.reset();
      await loadTickets();
    } catch(err) {
      alert("Erro ao criar chamado: " + err.message);
    }
  });

  refreshBtn.addEventListener("click", loadTickets);
  searchInput.addEventListener("input", renderTickets);

  // Details modal
  const detailsModal = document.getElementById("detailsModal");
  const detailsBody = document.getElementById("detailsBody");
  document.getElementById("closeDetailsBtn").addEventListener("click", closeDetails);

  async function openDetails(id) {
    currentDetailsId = id;
    const t = tickets.find(x => x.id === id) || await api(`/api/tickets/${id}`);
    detailsBody.innerHTML = `
      <p><strong>ID:</strong> ${t.id}</p>
      <p><strong>Assunto:</strong> ${escapeHtml(t.subject)}</p>
      <p><strong>Descrição:</strong><br/> ${escapeHtml(t.description)}</p>
      <p><strong>Cliente:</strong> ${escapeHtml(t.client)} ${t.client_email ? `(${escapeHtml(t.client_email)})` : ""}</p>
      <p><strong>Técnico:</strong> ${escapeHtml(t.tech)}</p>
      <p><strong>Prioridade:</strong> ${escapeHtml(t.priority)}</p>
      <p><strong>Status:</strong> ${escapeHtml(t.status)}</p>
      <p><strong>Data:</strong> ${escapeHtml(t.date)}</p>
    `;
    detailsModal.classList.remove("hidden");
    detailsModal.classList.add("flex");
  }
  function closeDetails(){ detailsModal.classList.add("hidden"); detailsModal.classList.remove("flex"); }

  // Edit from details (open edit modal)
  const editModal = document.getElementById("editModal");
  document.getElementById("openEditFromDetails").addEventListener("click", async () => {
    if (!currentDetailsId) return;
    const t = tickets.find(x => x.id === currentDetailsId) || await api(`/api/tickets/${currentDetailsId}`);
    currentEditId = t.id;
    document.getElementById("editSubject").value = t.subject;
    document.getElementById("editClient").value = t.client;
    document.getElementById("editClientEmail").value = t.client_email||"";
    document.getElementById("editTech").value = t.tech;
    document.getElementById("editPriority").value = t.priority;
    document.getElementById("editStatus").value = t.status;
    document.getElementById("editDescription").value = t.description||"";
    closeDetails();
    editModal.classList.remove("hidden");
    editModal.classList.add("flex");
  });

  document.getElementById("closeEditBtn").addEventListener("click", () => { editModal.classList.add("hidden"); editModal.classList.remove("flex"); });
  document.getElementById("closeDetailsBtn").addEventListener("click", closeDetails);

  document.getElementById("saveEditBtn").addEventListener("click", async () => {
    if (!currentEditId) return;
    const payload = {
      subject: document.getElementById("editSubject").value,
      description: document.getElementById("editDescription").value,
      client: document.getElementById("editClient").value,
      client_email: document.getElementById("editClientEmail").value,
      tech: document.getElementById("editTech").value,
      priority: document.getElementById("editPriority").value,
      status: document.getElementById("editStatus").value
    };
    try {
      await api(`/api/tickets/${currentEditId}`, { method: "PUT", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
      editModal.classList.add("hidden"); editModal.classList.remove("flex");
      await loadTickets();
      openDetails(currentEditId);
    } catch(err){
      alert("Erro ao salvar: " + err.message);
    }
  });

  // Close confirm modal
  const closeConfirm = document.getElementById("closeModalConfirm");
  document.getElementById("cancelCloseConfirm").addEventListener("click", () => { closeConfirm.classList.add("hidden"); closeConfirm.classList.remove("flex"); closeCandidateId = null; });
  document.getElementById("confirmCloseBtn").addEventListener("click", async () => {
    if (!closeCandidateId) return;
    try {
      await api(`/api/tickets/${closeCandidateId}/close`, { method: "POST" });
      closeConfirm.classList.add("hidden"); closeConfirm.classList.remove("flex");
      closeCandidateId = null;
      await loadTickets();
      // small visual feedback: highlight first matching row briefly
      const row = [...document.querySelectorAll("#ticketsList tr")].find(r => Number(r.children[0].textContent) === currentDetailsId);
      if (row) { row.classList.add("highlight"); setTimeout(()=>row.classList.remove("highlight"), 2000); }
    } catch(err){
      alert("Erro ao encerrar: " + err.message);
    }
  });

  function openCloseConfirm(id){
    closeCandidateId = id;
    document.getElementById("closeConfirmText").textContent = `Deseja encerrar o chamado #${id}?`;
    closeConfirm.classList.remove("hidden"); closeConfirm.classList.add("flex");
  }

  // Export handlers (client-side)
  generateBtn.addEventListener("click", (e) => { exportMenu.classList.toggle("hidden"); });
  document.addEventListener("click", (e) => { if (!generateBtn.contains(e.target) && !exportMenu.contains(e.target)) exportMenu.classList.add("hidden"); });

  exportExcelBtn.addEventListener("click", () => {
    const rows = tickets.map(t => ({ ID:t.id, Assunto:t.subject, Cliente:t.client, Email:t.client_email, Tecnico:t.tech, Prioridade:t.priority, Status:t.status, Data:t.date }));
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Chamados");
    XLSX.writeFile(wb, `chamados_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.xlsx`);
  });

  exportPDFBtn.addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    const head = [["ID","Assunto","Cliente","Técnico","Prioridade","Status","Data"]];
    const body = tickets.map(t => [t.id, t.subject, t.client, t.tech, t.priority, t.status, t.date]);
    doc.autoTable({ head, body, startY: 20 });
    doc.save(`chamados_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
  });

  // load initial
  await loadTickets();

})();
</script>
</body>
</html>
