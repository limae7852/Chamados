<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Sistema de Chamados - Final</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 6px; }

@keyframes highlight { 0% { box-shadow: none } 50% { box-shadow: 0 0 0 6px rgba(59,130,246,0.12) } 100% { box-shadow: none } }
.highlight { animation: highlight 900ms ease; }

.priority-low { border-left: 4px solid #10b981; }
.priority-medium { border-left: 4px solid #f59e0b; }
.priority-high { border-left: 4px solid #ef4444; }
.priority-critical { border-left: 4px solid #7c3aed; }

@keyframes blinkHighlight {
  0% { background-color: #fce7f3; }
  50% { background-color: #f9a8d4; }
  100% { background-color: #fce7f3; }
}
.blink { animation: blinkHighlight 1s ease-in-out 3; }

/* Small dropdown for export */
#exportMenu { min-width: 160px; }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="min-h-screen">
<header class="bg-orange-600 text-white shadow">
  <div class="container mx-auto px-4 py-4 flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold">Sistema de Chamados</h1>
      <p class="text-orange-100 text-sm">Gerencie seus atendimentos</p>
    </div>
    <nav class="space-x-2">
      <button id="tabTicketsBtn" class="px-3 py-2 rounded bg-orange-500 hover:bg-orange-400"><i class="fas fa-ticket-alt mr-2"></i>Chamados</button>
      <button id="tabConfigBtn" class="px-3 py-2 rounded bg-orange-500/70 hover:bg-orange-400/80"><i class="fas fa-cog mr-2"></i>Configurações</button>
    </nav>
  </div>
</header>

<main class="container mx-auto px-4 py-6">
<section id="tabTickets" class="space-y-6">

<!-- Estatísticas -->
<div id="statsGrid" class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-4">
  <div id="cardTotal" class="bg-white p-4 rounded shadow text-center">
    <h4 class="text-sm text-gray-500">Total</h4>
    <div id="statTotal" class="text-2xl font-bold">0</div>
  </div>
  <div id="cardOpen" class="bg-white p-4 rounded shadow text-center">
    <h4 class="text-sm text-gray-500">Abertos</h4>
    <div id="statOpen" class="text-2xl font-bold text-green-600">0</div>
  </div>
  <div id="cardInProgress" class="bg-white p-4 rounded shadow text-center">
    <h4 class="text-sm text-gray-500">Em andamento</h4>
    <div id="statInProgress" class="text-2xl font-bold text-yellow-600">0</div>
  </div>
  <div id="cardResolved" class="bg-white p-4 rounded shadow text-center">
    <h4 class="text-sm text-gray-500">Resolvidos</h4>
    <div id="statResolved" class="text-2xl font-bold text-blue-600">0</div>
  </div>
</div>

<!-- Filtros e ações -->
<div class="bg-white p-4 rounded shadow flex flex-col md:flex-row md:items-center md:justify-between gap-3">
  <div class="flex items-center gap-3 w-full md:w-auto flex-wrap">
    <div class="relative">
      <input id="searchInput" type="text" placeholder="Buscar assuntos, cliente, técnico..." class="pl-10 pr-3 py-2 border rounded w-72 focus:outline-none" />
      <i class="fas fa-search absolute left-3 top-2 text-gray-400"></i>
    </div>
    <select id="statusFilter" class="border rounded px-3 py-2">
      <option value="">Todos os status</option>
      <option value="open">Aberto</option>
      <option value="in-progress">Em andamento</option>
      <option value="resolved">Resolvido</option>
    </select>
    <select id="priorityFilter" class="border rounded px-3 py-2">
      <option value="">Todas as prioridades</option>
      <option value="low">Baixa</option>
      <option value="medium">Média</option>
      <option value="high">Alta</option>
      <option value="critical">Crítica</option>
    </select>
  </div>

  <div class="flex items-center gap-2 relative">
    <button id="generateReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"><i class="fas fa-file-export mr-2"></i>Gerar relatório</button>
    <div id="exportMenu" class="hidden absolute right-0 mt-12 bg-white border rounded shadow p-2 z-50">
      <button id="exportExcel" class="w-full text-left px-3 py-2 hover:bg-gray-100"><i class="fas fa-file-excel mr-2 text-green-600"></i>Exportar Excel</button>
      <button id="exportPDF" class="w-full text-left px-3 py-2 hover:bg-gray-100"><i class="fas fa-file-pdf mr-2 text-red-600"></i>Exportar PDF</button>
      <button id="exportCSV" class="w-full text-left px-3 py-2 hover:bg-gray-100"><i class="fas fa-file-csv mr-2 text-indigo-600"></i>Exportar CSV</button>
    </div>

    <button id="openTicketModal" class="bg-orange-600 hover:bg-orange-500 text-white px-4 py-2 rounded"><i class="fas fa-plus mr-2"></i>Abrir Chamado</button>
  </div>
</div>

<!-- Tabela de chamados -->
<div class="bg-white rounded shadow overflow-x-auto">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assunto</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Técnico</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prioridade</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
      </tr>
    </thead>
    <tbody id="ticketsList" class="bg-white divide-y divide-gray-200"></tbody>
  </table>
</div>
</section>

<!-- Configurações -->
<section id="tabConfig" class="hidden space-y-6">
<div class="bg-white p-4 rounded shadow">
  <h3 class="text-lg font-semibold mb-2">Configurações de E-mail (EmailJS)</h3>
  <p class="text-sm text-gray-600 mb-4">Preencha os dados abaixo com os IDs/keys do seu EmailJS.</p>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <label class="block"><span class="text-sm text-gray-700">Service ID</span><input id="cfgServiceId" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="service_xxxxx"/></label>
    <label class="block"><span class="text-sm text-gray-700">Template ID</span><input id="cfgTemplateId" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="template_xxxxx"/></label>
    <label class="block"><span class="text-sm text-gray-700">Public Key</span><input id="cfgPublicKey" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="user_xxxxx"/></label>
    <label class="block md:col-span-2"><span class="text-sm text-gray-700">E-mails internos (separados por vírgula)</span><input id="cfgInternals" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="suporte@empresa.com, gerente@empresa.com"/></label>
    <label class="block"><span class="text-sm text-gray-700">Assunto padrão - abertura</span><input id="cfgSubjectOpen" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="Novo chamado aberto"/></label>
    <label class="block"><span class="text-sm text-gray-700">Assunto padrão - encerramento</span><input id="cfgSubjectClose" type="text" class="mt-1 block w-full border rounded px-3 py-2" placeholder="Chamado encerrado"/></label>
  </div>
</div>
</section>

</main>
</div>

<!-- Modal Abrir Chamado -->
<div id="modalTicket" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg w-11/12 md:w-1/2 p-6 relative">
    <h2 class="text-lg font-bold mb-4">Abrir Chamado</h2>
    <form id="formTicket" class="space-y-3">
      <input type="hidden" id="ticketId">
      <div><label class="block">Assunto</label><input id="ticketSubject" type="text" class="w-full border rounded px-3 py-2"/></div>
      <div><label class="block">Cliente</label><input id="ticketClient" type="text" class="w-full border rounded px-3 py-2"/></div>
      <div><label class="block">Técnico</label><input id="ticketTech" type="text" class="w-full border rounded px-3 py-2"/></div>
      <div><label class="block">Prioridade</label>
        <select id="ticketPriority" class="w-full border rounded px-3 py-2">
          <option value="low">Baixa</option>
          <option value="medium">Média</option>
          <option value="high">Alta</option>
          <option value="critical">Crítica</option>
        </select>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button type="button" onclick="closeTicketModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-orange-600 rounded text-white hover:bg-orange-500">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Encerrar Chamado -->
<div id="modalCloseTicket" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-purple-50 rounded-lg w-11/12 md:w-1/3 p-6 relative border-2 border-purple-400 shadow-lg">
    <h2 class="text-lg font-bold mb-4 text-purple-800">Encerrar Chamado</h2>
    <p class="mb-4 text-purple-700">Tem certeza que deseja encerrar este chamado?</p>
    <div class="flex justify-end gap-2">
      <button type="button" onclick="closeCloseModal()" class="px-4 py-2 bg-purple-200 rounded hover:bg-purple-300">Cancelar</button>
      <button type="button" onclick="confirmCloseTicket()" class="px-4 py-2 bg-purple-600 rounded text-white hover:bg-purple-700">Encerrar</button>
    </div>
  </div>
</div>

<script>
let tickets = [];
let closeTicketId = null;

function updateStats() {
  document.getElementById("statTotal").textContent = tickets.length;
  document.getElementById("statOpen").textContent = tickets.filter(t=>t.status==='open').length;
  document.getElementById("statInProgress").textContent = tickets.filter(t=>t.status==='in-progress').length;
  document.getElementById("statResolved").textContent = tickets.filter(t=>t.status==='resolved').length;
}

function renderTickets() {
  const list = document.getElementById("ticketsList");
  list.innerHTML = "";
  tickets.forEach(ticket=>{
    const tr = document.createElement("tr");
    tr.classList.add(`priority-${ticket.priority}`);
    tr.innerHTML = `
      <td class="px-4 py-2">${ticket.id}</td>
      <td class="px-4 py-2">${ticket.subject}</td>
      <td class="px-4 py-2">${ticket.client}</td>
      <td class="px-4 py-2">${ticket.tech}</td>
      <td class="px-4 py-2 capitalize">${ticket.priority}</td>
      <td class="px-4 py-2 capitalize">${ticket.status.replace("-", " ")}</td>
      <td class="px-4 py-2">${ticket.date}</td>
      <td class="px-4 py-2 space-x-2">
        <button onclick="editTicket(${ticket.id})" class="text-blue-600 hover:underline">Editar</button>
        ${ticket.status !== "resolved" ? `<button onclick="openCloseModal(${ticket.id})" class="text-green-600 hover:underline">Encerrar</button>` : ""}
      </td>
    `;
    list.appendChild(tr);

    if(ticket.priority === "critical") tr.classList.add("blink");
  });
  updateStats();
}

// Modal funções
function openTicketModal() { document.getElementById("modalTicket").classList.remove("hidden"); }
function closeTicketModal() { document.getElementById("modalTicket").classList.add("hidden"); document.getElementById("formTicket").reset(); }
function openCloseModal(id) { closeTicketId=id; document.getElementById("modalCloseTicket").classList.remove("hidden"); }
function closeCloseModal() { closeTicketId=null; document.getElementById("modalCloseTicket").classList.add("hidden"); }

// CRUD
document.getElementById("formTicket").addEventListener("submit", e=>{
  e.preventDefault();
  const idField = document.getElementById("ticketId");
  const subject = document.getElementById("ticketSubject").value;
  const client = document.getElementById("ticketClient").value;
  const tech = document.getElementById("ticketTech").value;
  const priority = document.getElementById("ticketPriority").value;
  const date = new Date().toLocaleString();

  if(idField.value){
    // Editar
    const t = tickets.find(t=>t.id==idField.value);
    t.subject=subject; t.client=client; t.tech=tech; t.priority=priority;
  } else {
    // Novo
    const id = tickets.length ? tickets[tickets.length-1].id+1 : 1;
    tickets.push({id,subject,client,tech,priority,status:'open',date});
  }
  renderTickets();
  closeTicketModal();
});

// Encerrar chamado
function confirmCloseTicket(){
  if(closeTicketId!==null){
    const t = tickets.find(t=>t.id===closeTicketId);
    t.status='resolved';
    const tr = [...document.querySelectorAll("#ticketsList tr")].find(r=>r.firstChild.textContent==t.id);
    tr.classList.add("highlight");
    closeCloseModal();
    renderTickets();
    alert(`Chamado #${t.id} encerrado com sucesso!`);
  }
}

// Tabs
document.getElementById("tabTicketsBtn").addEventListener("click",()=>{document.getElementById("tabTickets").classList.remove("hidden"); document.getElementById("tabConfig").classList.add("hidden");});
document.getElementById("tabConfigBtn").addEventListener("click",()=>{document.getElementById("tabConfig").classList.remove("hidden"); document.getElementById("tabTickets").classList.add("hidden");});

// Botões principais
document.getElementById("openTicketModal").addEventListener("click", openTicketModal);
</script>
</body>
</html>
